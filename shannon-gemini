#!/bin/bash
# Shannon-Gemini CLI

set -e

# Load .env if present
if [ -f .env ]; then
  set -a
  source .env
  set +a
fi

case "$OSTYPE" in
  msys*) export MSYS_NO_PATHCONV=1 ;;
esac

COMPOSE_FILE="docker-compose.yml"

cmd_start() {
    # Basic arg parsing for URL/REPO
    for arg in "$@"; do
        case "$arg" in
            URL=*) URL="${arg#URL=}" ;;
            REPO=*) REPO="${arg#REPO=}" ;;
        esac
    done

    if [ -z "$URL" ] || [ -z "$REPO" ]; then
        echo "Usage: ./shannon-gemini start URL=<url> REPO=<name>"
        exit 1
    fi

    echo "Starting Shannon-Gemini services..."
    docker compose -f "$COMPOSE_FILE" up -d --build

    echo "Submitting workflow..."
    docker compose -f "$COMPOSE_FILE" exec -T worker 
        node dist/temporal/client.js "$URL" "$REPO"
}

cmd_stop() {
    docker compose -f "$COMPOSE_FILE" down
}

case "${1:-help}" in
    start)
        shift
        cmd_start "$@"
        ;;
    stop)
        shift
        cmd_stop "$@"
        ;;
    *)
        echo "Usage: ./shannon-gemini {start|stop}"
        ;;
esac
