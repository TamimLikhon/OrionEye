import { BaseAgent } from "./base-agent.js";
import { 
    VULN_INJECTION_SYSTEM_PROMPT, 
    VULN_XSS_SYSTEM_PROMPT, 
    VULN_AUTH_SYSTEM_PROMPT, 
    VULN_AUTHZ_SYSTEM_PROMPT, 
    VULN_SSRF_SYSTEM_PROMPT 
} from "../ai/prompts.js";

export type VulnType = 'injection' | 'xss' | 'auth' | 'authz' | 'ssrf';

const PROMPT_MAP: Record<VulnType, string> = {
    'injection': VULN_INJECTION_SYSTEM_PROMPT,
    'xss': VULN_XSS_SYSTEM_PROMPT,
    'auth': VULN_AUTH_SYSTEM_PROMPT,
    'authz': VULN_AUTHZ_SYSTEM_PROMPT,
    'ssrf': VULN_SSRF_SYSTEM_PROMPT
};

export class VulnerabilityAgent extends BaseAgent {
    private type: VulnType;

    constructor(apiKey: string, type: VulnType) {
        super(apiKey, PROMPT_MAP[type]);
        this.type = type;
    }

    async run(input: { url: string; repoPath: string; reconFindings: any; codeAnalysis?: string }): Promise<any> {
        const findingsStr = JSON.stringify(input.reconFindings, null, 2);
        
        const prompt = `
        Target URL: ${input.url}
        Repository Path: ${input.repoPath}
        
        Reconnaissance Findings:
        ${findingsStr}

        ${input.codeAnalysis ? `Code Analysis Context:
${input.codeAnalysis}` : ''}

        Start your ${this.type.toUpperCase()} Vulnerability Analysis.
        1. Identify potential sinks for ${this.type}.
        2. Trace inputs to these sinks.
        3. Document hypothesized exploitable paths.
        4. Produce 'deliverables/${this.type}_analysis_deliverable.md' and 'deliverables/${this.type}_exploitation_queue.json'.
        `;

        const result = await this.executor.execute(prompt);
        return { 
            type: this.type,
            rawOutput: result 
        };
    }
}
